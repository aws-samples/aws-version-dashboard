AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'aws-check-versions

  SAM Template for aws-check-versions

  '
Globals:
  Function:
    Timeout: 60
Parameters:
  SingleOrMultiAccountDeployment:
    Type: String
    Default: Single
    AllowedValues:
    - Single
    - Multi
    Description: Select Single or Multi Account Deployment
  SpecifyAccountsOrEnterAll:
    Type: String
    Default: 111111111111,222222222222
    Description: Enter an Account ID, a comma delimited list of accounts, enter ALL
      for an entire AWS Organization, or replace the accounts.csv file with a list
      of comma delimited accounts
Resources:
  RDSLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: aws-ver-dash-lambda-rds
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - sts:AssumeRole
          Principal:
            Service:
            - lambda.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - rds:DescribeDBInstances
            - rds:DescribeDBEngineVersions
            Resource: '*'
        PolicyName: LambdaRDSDescribe
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
        PolicyName: LambdaCloudwatchWrite
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - sts:AssumeRole
            Resource: arn:aws:iam::*:role/aws-ver-dash-lambda-rds
        PolicyName: RDSAssumeRole
  ESLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: aws-ver-dash-lambda-es
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - sts:AssumeRole
          Principal:
            Service:
            - lambda.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - es:ListDomainNames
            - es:DescribeElasticSearchDomain
            - es:ListElasticsearchVersions
            Resource: '*'
        PolicyName: LambdaESDescribe
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
        PolicyName: LambdaCloudwatchWrite
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - sts:AssumeRole
            Resource: arn:aws:iam::*:role/aws-ver-dash-lambda-es
        PolicyName: ESAssumeRole
  ECLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: aws-ver-dash-lambda-ec
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - sts:AssumeRole
          Principal:
            Service:
            - lambda.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - elasticache:DescribeCacheClusters
            - elasticache:DescribeCacheEngineVersions
            Resource: '*'
        PolicyName: LambdaECDescribe
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
        PolicyName: LambdaCloudwatchWrite
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - sts:AssumeRole
            Resource: arn:aws:iam::*:role/aws-ver-dash-lambda-ec
        PolicyName: ECAssumeRole
  MSKLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: aws-ver-dash-lambda-msk
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - sts:AssumeRole
          Principal:
            Service:
            - lambda.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - kafka:ListClusters
            - kafka:ListConfigurations
            - kafka:ListKafkaVersions
            Resource: '*'
        PolicyName: LambdaMSKDescribe
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
        PolicyName: LambdaCloudwatchWrite
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - sts:AssumeRole
            Resource: arn:aws:iam::*:role/aws-ver-dash-lambda-msk
        PolicyName: MSKAssumeRole
  MQLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: aws-ver-dash-lambda-mq
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - sts:AssumeRole
          Principal:
            Service:
            - lambda.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - mq:ListBrokers
            - mq:ListConfigurations
            - mq:DescribeBroker
            - mq:DescribeBrokerEngineTypes
            Resource: '*'
        PolicyName: LambdaMQDescribe
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
        PolicyName: LambdaCloudwatchWrite
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - sts:AssumeRole
            Resource: arn:aws:iam::*:role/aws-ver-dash-lambda-mq
        PolicyName: MQAssumeRole
  EKSLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: aws-ver-dash-lambda-eks
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - sts:AssumeRole
          Principal:
            Service:
            - lambda.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - eks:DescribeCluster
            - eks:ListClusters
            Resource: '*'
        PolicyName: LambdaEKSDescribe
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
        PolicyName: LambdaCloudwatchWrite
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - sts:AssumeRole
            Resource: arn:aws:iam::*:role/aws-ver-dash-lambda-eks
        PolicyName: EKSAssumeRole
  CombineLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - sts:AssumeRole
          Principal:
            Service:
            - lambda.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - s3:PutObject
            Resource:
              Fn::Join:
              - /
              - - Fn::GetAtt:
                  - VersionsS3Bucket
                  - Arn
                - '*'
        PolicyName: LambdaS3PutPolicy
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
        PolicyName: LambdaCloudwatchWrite
  VersionAcctListExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - sts:AssumeRole
          Principal:
            Service:
            - lambda.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - organizations:ListAccounts
            - organizations:DescribeOrganization
            Resource: '*'
        PolicyName: LambdaS3PutPolicy
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
        PolicyName: LambdaCloudwatchWrite
  CombineAcctLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - sts:AssumeRole
          Principal:
            Service:
            - lambda.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - s3:PutObject
            - s3:GetObject
            Resource:
              Fn::Join:
              - /
              - - Fn::GetAtt:
                  - VersionsS3Bucket
                  - Arn
                - '*'
        PolicyName: LambdaS3PutPolicy
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - s3:ListBucket
            Resource:
              Fn::GetAtt:
              - VersionsS3Bucket
              - Arn
        PolicyName: LambdaS3ListPolicy
      - PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
        PolicyName: LambdaCloudwatchWrite
  LambdaInvokeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - states.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: LambdaInvokePolicy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - lambda:InvokeFunction
            Resource:
            - Fn::GetAtt:
              - VersionAcctListFunction
              - Arn
            - Fn::GetAtt:
              - VersionRdsFunction
              - Arn
            - Fn::GetAtt:
              - VersionEsFunction
              - Arn
            - Fn::GetAtt:
              - VersionEcFunction
              - Arn
            - Fn::GetAtt:
              - VersionDocDBFunction
              - Arn
            - Fn::GetAtt:
              - VersionEKSFunction
              - Arn
            - Fn::GetAtt:
              - VersionMSKFunction
              - Arn
            - Fn::GetAtt:
              - VersionMQFunction
              - Arn
            - Fn::GetAtt:
              - VersionCombineFunction
              - Arn
            - Fn::GetAtt:
              - VersionCombineAcctsFunction
              - Arn
      - PolicyName: StepCloudwatchWrite
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogDelivery
            - logs:GetLogDelivery
            - logs:UpdateLogDelivery
            - logs:DeleteLogDelivery
            - logs:ListLogDeliveries
            - logs:PutResourcePolicy
            - logs:DescribeResourcePolicies
            - logs:DescribeLogGroups
            Resource: '*'
  StepFunctionInvokeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - events.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: StepFunctionInvokePolicy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - states:StartExecution
            Resource:
            - Ref: VersionStateMachine
  LambdaStepInvokeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: LambdaStepFunctionInvokePolicy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - states:StartExecution
            Resource:
            - Ref: VersionStateMachine
      - PolicyName: LambdaWriteLogs
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
  ScheduleStepFunctions:
    Type: AWS::Events::Rule
    Properties:
      Description: Trigger Weekly for Step Function
      ScheduleExpression: cron(0 6 ? * FRI *)
      State: ENABLED
      Targets:
      - Arn:
          Ref: VersionStateMachine
        Id: TargetVersionStateMachine
        RoleArn:
          Fn::GetAtt:
          - StepFunctionInvokeRole
          - Arn
  VersionsS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  VersionStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: version-dashboard-statemachine
      Type: EXPRESS
      Logging:
        Level: ERROR
        Destinations:
        - CloudWatchLogsLogGroup:
            LogGroupArn:
              Fn::GetAtt:
              - StepFunctionLogGroup
              - Arn
      DefinitionUri: ../../version_state_machine/version_state_machine.asl.json
      DefinitionSubstitutions:
        VersionAcctListFunctionArn:
          Fn::GetAtt:
          - VersionAcctListFunction
          - Arn
        VersionRdsFunctionArn:
          Fn::GetAtt:
          - VersionRdsFunction
          - Arn
        VersionEsFunctionArn:
          Fn::GetAtt:
          - VersionEsFunction
          - Arn
        VersionDocDBFunctionArn:
          Fn::GetAtt:
          - VersionDocDBFunction
          - Arn
        VersionEKSFunctionArn:
          Fn::GetAtt:
          - VersionEKSFunction
          - Arn
        VersionMSKFunctionArn:
          Fn::GetAtt:
          - VersionMSKFunction
          - Arn
        VersionMQFunctionArn:
          Fn::GetAtt:
          - VersionMQFunction
          - Arn
        VersionEcFunctionArn:
          Fn::GetAtt:
          - VersionEcFunction
          - Arn
        VersionCombineFunctionArn:
          Fn::GetAtt:
          - VersionCombineFunction
          - Arn
        VersionCombineAcctsFunctionArn:
          Fn::GetAtt:
          - VersionCombineAcctsFunction
          - Arn
      Role:
        Fn::GetAtt:
        - LambdaInvokeRole
        - Arn
  StepFunctionLogGroup:
    Type: AWS::Logs::LogGroup
  VersionAcctListFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: VersionAcctListFunction
      Handler: app.lambda_handler
      Runtime: python3.7
      Role:
        Fn::GetAtt:
        - VersionAcctListExecutionRole
        - Arn
      Environment:
        Variables:
          ACCOUNTS:
            Ref: SpecifyAccountsOrEnterAll
  VersionRdsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: VersionRdsFunction
      Handler: app.lambda_handler
      Runtime: python3.7
      Role:
        Fn::GetAtt:
        - RDSLambdaExecutionRole
        - Arn
  VersionEsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: VersionEsFunction
      Handler: app.lambda_handler
      Runtime: python3.7
      Role:
        Fn::GetAtt:
        - ESLambdaExecutionRole
        - Arn
  VersionEcFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: VersionEcFunction
      Handler: app.lambda_handler
      Runtime: python3.7
      Role:
        Fn::GetAtt:
        - ECLambdaExecutionRole
        - Arn
  VersionDocDBFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: VersionDocDBFunction
      Handler: app.lambda_handler
      Runtime: python3.7
      Role:
        Fn::GetAtt:
        - RDSLambdaExecutionRole
        - Arn
  VersionMSKFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: VersionMSKFunction
      Handler: app.lambda_handler
      Runtime: python3.7
      Role:
        Fn::GetAtt:
        - MSKLambdaExecutionRole
        - Arn
  VersionMQFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: VersionMQFunction
      Handler: app.lambda_handler
      Runtime: python3.7
      Role:
        Fn::GetAtt:
        - MQLambdaExecutionRole
        - Arn
  VersionEKSFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: VersionEKSFunction
      Handler: app.lambda_handler
      Runtime: python3.7
      Role:
        Fn::GetAtt:
        - EKSLambdaExecutionRole
        - Arn
  InvokeVersionStep:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: InvokeVersionStep
      Handler: app.lambda_handler
      Runtime: python3.7
      Environment:
        Variables:
          StepFunctionArn:
            Ref: VersionStateMachine
      Role:
        Fn::GetAtt:
        - LambdaStepInvokeRole
        - Arn
  VersionCombineFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: VersionCombineFunction
      Handler: app.lambda_handler
      Runtime: python3.7
      Environment:
        Variables:
          s3BucketName:
            Ref: VersionsS3Bucket
      Role:
        Fn::GetAtt:
        - CombineLambdaExecutionRole
        - Arn
  VersionCombineAcctsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: VersionCombineAcctsFunction
      Handler: app.lambda_handler
      Runtime: python3.7
      MemorySize: 1024
      Timeout: 300
      Environment:
        Variables:
          s3BucketName:
            Ref: VersionsS3Bucket
      Role:
        Fn::GetAtt:
        - CombineAcctLambdaExecutionRole
        - Arn
  TriggerStepFunction:
    Type: Custom::TriggerStepFunction
    Version: '1.0'
    Properties:
      ServiceToken:
        Fn::GetAtt:
        - InvokeVersionStep
        - Arn
      Region:
        Ref: AWS::Region
      Version: '1.3'
Outputs:
  VersionsS3Bucket:
    Description: S3 Bucket for latest version files
    Value:
      Ref: VersionsS3Bucket
